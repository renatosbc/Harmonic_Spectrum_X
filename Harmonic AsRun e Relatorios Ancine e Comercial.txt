- Relatórios AsRun:
ftp://ftpuser:ftpuser@10.0.0.110/TV-1/

- Advanced XML Conversor (Windows)
Consegue ler cada xml, mas com alguns campos interpretados a mais


- Para montar o ftp em outra máquina:
https://linuxconfig.org/mount-remote-ftp-directory-host-locally-into-linux-filesystem
apt-get install curlftpfs (+ modprobe fuse, se necessário)
mkdir -p /root/Harmonic_AsRun/AsRun_mount
curlftpfs ftpuser:ftpuser@10.0.0.110/TV-1/ /root/Harmonic_AsRun/AsRun_mount

- Criar o usuário root (ou o que for rodar a rotina) e dar privilégios para ele acessar e modificar o banco de dados.

- Para criar um índice único no MySQL (o HeidiSQL não faz isso)
mysql> USE AsRun;
mysql> ALTER TABLE AsRun ADD CONSTRAINT unique_key UNIQUE (AstraID);

- AstraId em duplicidade!  Lançamentos exatamente iguais em dois xml diferentes. Por exemplo:
(o mysql não permite a inserção pois AstraId é índice único)
ERROR 1062 (23000) at line 1: Duplicate entry '28242C385BA2601BL1I' for key 'unique_key'
/root/Harmonic_AsRun/AsRun_local_a_processar/E1809136.TV-1, 18 - 1.2.0,SAP140,VS1


- Crontab
crontab -e
#Processa o AsRun do Harnic-Aveco todos os dias
0 2 * * *  /root/AsRun/ftp2mysql.sh

- FrontEnds prontos?:
https://www.quora.com/What-would-be-the-best-report-generator-tool-for-mySQL-DB-that-is-web-based-and-open-source
https://www.databasejournal.com/features/mysql/slideshows/top-reporting-tools-for-mysql-in-2018.html
https://www.databasejournal.com/features/mysql/generating-reports-on-mysql-data.html
https://www.w3schools.com/php/php_mysql_select.asp

-NGinx
alterar o nginx.conf para que ele reconheça também index.php como página inicial

- HeidiSQL
.Relatório Ancine (incluir .swf?)
SELECT "(num fixo)" AS 'Num Ancine', DATE_FORMAT(LEFT(RealStart,10), "%d/%m/%y") AS 'Data', MID(RealStart, 12, 8) AS 'Início', ADDTIME (MID(RealStart, 12, 8), LEFT(RealDuration, 8)) AS "Término", `JobId` AS "Nome (JobId)", "(custom1)" as 'Diretor',  "(custom2)" as 'CPB', "(custom3)" as 'CRT', `Name` AS 'Título Original', '(ano)' AS 'Ano', `MovieType` AS 'Tipo', '(cod)' AS 'Código' FROM AsRun.AsRun WHERE `JobId` NOT LIKE '%.swf' AND DATE(LEFT(RealStart,10)) BETWEEN '2019-01-01' AND '2019-01-31' ORDER BY `RealStart`

.Relatório de Veiculação
SELECT DATE_FORMAT(LEFT(RealStart,10), "%d/%m/%Y") AS 'Data', MID(RealStart, 12, 8) AS 'Entrada', ADDTIME (MID(RealStart, 12, 8), LEFT(RealDuration, 8)) AS "Saída", `JobId` AS "Código", Name AS titulo ,LEFT(RealDuration, 8) AS 'Duração', Channel AS "Canal" FROM AsRun.AsRun WHERE `Name` LIKE 'VIDA%' AND `JobId` NOT LIKE '%.swf' ORDER BY `RealStart`


. apt-get install xml2 curlftpfs
---------------------------------------------------------------------------
#!/bin/bash
#/root/AsRun/ftp2mysql.sh

#redireciona todas as saídas para o arquivo de log
savelog -l /var/log/AsRun.log > /dev/null
exec 2>&1 1>/var/log/AsRun.log

endereco=$(realpath $0)
dir=$(echo $endereco | sed 's/ftp2mysql.sh//')

echo "["$(date)"] "$endereco
echo "Processamento iniciado"

#Se não existentes, cria o diretórios para cópia local e montagem do FTP dos relatórios AsRun
mkdir -p $dir"AsRun_a_processar"
mkdir -p $dir"AsRun_ja_processado"
mkdir -p $dir"AsRun_mount"
rm -f $dir"AsRun_local_a_processar/*"
rm -f $dir"temp_*"

umount $dir"AsRun_mount" 2> /dev/null

#Copia AsRun (montado via curlftpfs) para diretório local e depois desmonta o FTP
#apt-get install curlftpfs (+ modprobe fuse)

curlftpfs ftpuser:ftpuser@10.0.0.110/TV-1/ $dir"AsRun_mount"
result=$?
if [ $result = 0 ]
  then echo "Conectado ao servidor Aveco"
  else echo -e "[\033[31mERRO!\033[37m]Não foi possível conectar ao servidor Aveco."; echo "Programa encerrado devido a erro."; exit 0
fi

echo "Verificando se há novos relatórios para transferir e processar"
diff -q $dir"AsRun_ja_processado/" $dir"AsRun_mount/" | grep "Only in $dir"AsRun_mount"/" | sed 's/Only in //' | sed 's/: //' | xargs -n 1 -I{} cp -v {} $dir"AsRun_a_processar"

if [ -z "$(ls -A $dir"AsRun_a_processar")" ]; then
   echo "*Não há arquivos a processar"
   umount $dir"AsRun_mount"
   echo "Desconectado do servidor Aveco"
   echo "Processamnento Finalizado"
   exit 0
fi

echo "Novos Relatórios Transferidos"
echo "Desconectando do servidor Aveco"
umount $dir"AsRun_mount"

echo
echo "Processando novos arquivos"
echo

#limpa apóstrofos como arquivado pelo Aveco
echo "Limpando apóstrofos (&apos;)"
for file in $dir"AsRun_a_processar/*"; do
  sed -i 's/&apos;//' $file
done

shopt -s extglob
num_processados=0
num_lancamentos=0

#Elenca todos os arquivos .TV-1 e .TV-1.part em $dir"AsRun_a_processar"
for arquivo in $dir"AsRun_a_processar/"*.+(TV-1|TV-1.part); do

  #(ler cabeçalho do xml)
  {
  sed -n '1,4p' $arquivo | xml2 | sed 's/\/ASTRA_DIFACE_LITE_v1_2\/@//'  | sed 's/\/ASTRA_DIFACE_LITE_v1_2\/Plan\///' | sed 's/\/ASTRA_DIFACE_LITE_v1_2\/Info\///' | sed '/=/! s/$/=/' | sed 's/=/="/' | sed 's/$/"/' > $dir"/temp_head.txt"
} 2> /dev/null
  source $dir"temp_head.txt"

  #verifica se a versão do xml e´a correta
  if [ "$dtd_version" != "1.2.0" ]; then
    echo "VERSÃO DO XML DIFERENTE DE 1.2.0 !" no arquivo $arquivo; echo; exit 0
  fi

  #primeira linha apos o cabecalho (xml 1.2.0)
  linha=6

  #Le o restante do arquivo linha-a-linha
  while true; do

    #verifica final do xml
    input=$(sed -n "$linha"p $arquivo)
    if [ "$input" = "</Events>" ]; then echo "Encontrada tag de final do XML ( </Events> )"; echo; break
    fi

    #verifica se e´linha em branco
    if [ "$input" = "" ]; then echo "Encontrada linha em branco. Pulando para a próxima linha."; linha=$(($linha + 1)); echo; echo; continue
    fi


    #(ler ebep)
    #para ver em hexa: echo -e $ebep | od -t x1c
    {
      ebep=$(sed -n "$linha"p $arquivo | xml2 | grep '/Event/EbEPTokens/ebepDescr/' | sed 's/\/Event\/EbEPTokens\/ebepDescr\/ebepName=//' | sed 's/\/Event\/EbEPTokens\/ebepDescr\/ebepValue=/="/' | sed 's/EbEPTokens\/ebepDescr//' | sed 's/\/Events\/Event\///' | sed '/=/ s/$/"/' | sed 's/ =/=/')

echo $ebep | sed 's/ =/=/g' | sed 's/ /\n/g' > $dir"temp_ebep.txt"
} 2> /dev/null
    source $dir"temp_ebep.txt"

    #(ler demais dados)
    {
    sed -n "$linha"p $arquivo | xml2 | grep -v "EbEPTokens" | sed 's/\/Event\///' | sed '/=/! s/$/=/' | sed 's/=/="/' | sed 's/$/"/' > $dir"temp_body.txt"
} 2> /dev/nul
    source $dir"temp_body.txt"

    XmlOrig=$(basename $arquivo)

    mysql -e "INSERT INTO AsRun.AsRun (XmlOrig, dtd_version, Created, Channel, Date, PartNo, ExtId, Idec, JobId, DataShare, BcastDay, PlanStart, PlanDuration, PlanStartMin, PlanStartMax, PlanDurMin, PlanDurMax, RealStart, RealDuration, Name, StartType, DurationType, ManualStart, Flags, ParType, ParCounter, SignalType, DevType, Device, MatPath, MovieType, InAddr, OutAddr, ColorInfo, AudioInfo, InlineLogo, VPS, Note, StlId, Custom1, Custom2, Custom3, Custom4, AltType, AltCounter, AstraId, EventType, OnAirState, Transition, Name2, TechNote, ClipNote, ClipStatus, Crit1, Crit2, Crit3, Crit4, OrigInAddr, OrigOutAddr, Folder, StlFile, StlOffset, ScreenFormat, VideoFormat, AudioFormat, FileFormat, TotalBitrate, TotalFileSize, SrcDevice, SrcMatPath, SrcJobId, SrcInAddr, SrcOutAddr, SrcId, Keywords, Warranty, ErrStatus, ErrDescr, VIRTUAL_RECORDER_ID, DBSNC_MOD, DBSNC_STAT, DEVTYP, EVENT_VER, EVENT_VER_SELF) VALUES ('$XmlOrig', '$dtd_version', '$Created', '$Channel', '$Date', '$PartNo', '$ExtId', '$Idec', '$JobId', '$DataShare', '$BcastDay', '$PlanStart', '$PlanDuration', '$PlanStartMin', '$PlanStartMax', '$PlanDurMin', '$PlanDurMax', '$RealStart', '$RealDuration', '$Name', '$StartType', '$DurationType', '$ManualStart', '$Flags', '$ParType', '$ParCounter', '$SignalType', '$DevType', '$Device', '$MatPath', '$MovieType', '$InAddr', '$OutAddr', '$ColorInfo', '$AudioInfo', '$InlineLogo', '$VPS', '$Note', '$StlId', '$Custom1', '$Custom2', '$Custom3', '$Custom4', '$AltType', '$AltCounter', '$AstraId', '$EventType', '$OnAirState', '$Transition', '$Name2', '$TechNote', '$ClipNote', '$ClipStatus', '$Crit1', '$Crit2', '$Crit3', '$Crit4', '$OrigInAddr', '$OrigOutAddr', '$Folder', '$StlFile', '$StlOffset', '$ScreenFormat', '$VideoFormat', '$AudioFormat', '$FileFormat', '$TotalBitrate', '$TotalFileSize', '$SrcDevice', '$SrcMatPath', '$SrcJobId', '$SrcInAddr', '$SrcOutAddr', '$SrcId', '$Keywords', '$Warranty', '$ErrStatus', '$ErrDescr', '$VIRTUAL_RECORDER_ID', '$DBSNC_MOD', '$DBSNC_STAT', '$DEVTYP', '$EVENT_VER', '$EVENT_VER_SELF')"

    echo $XmlOrig", "$linha" - "$dtd_version","$JobId

    linha=$(($linha + 1))
    num_lancamentos=$(($num_lancamentos + 1))

  done

num_processados=$(($num_processados + 1))

#move o arquivo já processado para a devida pasta
mv $arquivo $dir"AsRun_ja_processado/"

done

#deleta arquivos temporarios
rm -f $dir"temp_"*

echo "Processamnento Finalizado"
echo "Arquivos: "$num_processados
echo "Lançamentos: "$num_lancamentos
echo

exit 0
---------------------------------------------------------------------------



INTERFACE WEB 

- RELATÓRIO VEICULAÇÃO
---------------------------------------------------------------------------
<html>
<?php  // /usr/local/nginx/html/veiculacao.php ?>

<head>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1" />
<title>Relatório de Veiculação</title>

<style>
span.tab{
    padding: 0 50px;
}

table {
  border: 1px solid black;
}

th {
  border-bottom: 1px solid #ddd;
  border-collapse: collapse;
  background-color:#f3f3f3;
  text-align: center
  padding: 3px;
  font-size: 16px;
}

td {
  border-bottom: 1px solid #ddd;
  border-collapse: collapse;
  text-align: center
  padding: 3px;
  font-size: 10px;
  height: 20px;
  text-align: center;
}

tr:hover {background-color:#f3f3f3;}

// img { vertical-align: middle; }

</style>
</head>

<body>

<font face = "Verdana">
<h1 style=font-size:45px><img src="./redenew_logo_asrun.png" alt="logo_redenew face" height="80"><span class="tab"></span><u>Relatório de Veiculação</u></h1>

<form action="#">
  Título: <input type="text" name="Ptitulo" autofocus value="<?php echo ($_GET['Ptitulo']); ?>">
  Código: <input type="text" name="Pcodigo" value="<?php echo ($_GET['Pcodigo']); ?>">

  <?php 
  $d = strtotime("yesterday");
  $ontem = date("Y-m-d", $d);

  // trata datas iniciais mnaiores que finais vindas da sessão anterior
  if ( !isset($_GET['Pdatainicial']) ) {
    echo ' Inicio: <input type="date" name="Pdatainicial" value='.$ontem.">";
  } else {
    if ( $_GET['Pdatainicial'] > $_GET['Pdatafinal'] ) {
      echo ' Inicio: <input type="date" name="Pdatainicial" value='.$_GET['Pdatafinal'].">";
    } else {
      echo ' Inicio: <input type="date" name="Pdatainicial" value='.$_GET['Pdatainicial'].">";
    }
  }

  if ( !isset($_GET['Pdatafinal']) ){
    echo ' Fim: <input type="date" name="Pdatafinal" value='.$ontem.">";
  } else {
    if ( $_GET['Pdatainicial'] > $_GET['Pdatafinal'] ) {
      echo ' Fim: <input type="date" name="Pdatafinal" value='.$_GET['Pdatainicial'].">";
    } else {
      echo ' Fim: <input type="date" name="Pdatafinal" value='.$_GET['Pdatafinal'].">";
    }
  }

  ?>

  &nbsp;&nbsp;<input type="submit" value="Pesquisar" style="height:25px"></br>

  <?php 

    // trata data inicial maior que a final vinda do formulario
    if ( $_GET['Pdatainicial'] > $_GET['Pdatafinal'] ) {
      $tmp = $_GET['Pdatainicial'];
      $_GET['Pdatainicial'] = $_GET['Pdatafinal'];
      $_GET['Pdatafinal'] = $tmp;
    }

    // mantem a ultima opcao escolhida no botao
    if ( $_GET['Pswf'] == "y" ){
      echo '<input type="hidden" name="Pswf" value="n" >';
      echo '<input type="checkbox" name="Pswf" value="y" checked >';
    } else {
      echo '<input type="hidden" name="Pswf" value="n" checked >';
      echo '<input type="checkbox" name="Pswf" value="y" >';
    }
  ?>

  <small>incluir eventos flash</small>
  
  <?php
    if ( !isset ($_SERVER['HTTP_REFERER']) ) {
      echo '<span class="tab"></span><span class="tab"></span><small><small><font color="red">(visão inicial - apenas ontem, sem flash)</font></small></small>';
    }
  ?>

  </br>
</form>


<?php 

header("Content-Type: text/html; charset=ISO-8859-1",true); 

// funções

function test_input($data) {
  $data = trim($data);
  $data = stripslashes($data);
  $data = htmlspecialchars($data);
  return $data;
}


/*
  if ($_SERVER["REQUEST_METHOD"] == "POST") {
  $name = test_input($_POST["Ptitulo"]);
}  
*/


// dados iniciais
$Ptitulo = $Pcodigo = $sql = "";
$Pswf = "n";
$d=strtotime("yesterday");
$Pdatainicial = $Pdatafinal = date("Y-m-d", $d);

ini_set('display_errors', true);
error_reporting(E_ALL|E_STRICT);

if(!empty($_GET) && $_SERVER['REQUEST_METHOD'] == 'GET'){
    $Ptitulo = test_input($_GET['Ptitulo']);
    $Pcodigo = test_input($_GET['Pcodigo']);
    $Pdatainicial = test_input($_GET['Pdatainicial']);
    $Pdatafinal = test_input($_GET['Pdatafinal']);
    $Pswf = $_GET['Pswf'];
} 


if ($Pdatainicial == ''){
  $d=strtotime("yesterday");
  $Pdatainicial = date("Y-m-d", $d);
}

if ($Pdatafinal == ''){
  $d=strtotime("yesterday");
  $Pdatafinal = date("Y-m-d", $d);
}


// Create connection
$username = "root";
$password = "g2p88";
$server = "10.0.0.160";
$database = "AsRun";

$conn = new mysqli($server, $username, $password, $database);

// Check connection
if (!$conn) {
    die("Connection failed: " . mysqli_connect_error());
}

if ($Pswf == "n") {
  $sql = "SELECT DATE_FORMAT(LEFT(RealStart,10),'%d/%m/%Y') AS data, MID(RealStart,12,8) AS entrada, ADDTIME (MID(RealStart, 12, 8),LEFT(RealDuration,8)) AS saida, JobId AS codigo, Name AS titulo, LEFT(RealDuration,8) AS duracao, Channel AS canal FROM AsRun.AsRun WHERE Name LIKE '%$Ptitulo%' AND JobId NOT Like '%.swf' AND JobId NOT Like '%.png' AND JobId LIKE '%$Pcodigo%' AND (DATE(RealStart) BETWEEN '$Pdatainicial' AND '$Pdatafinal') ORDER BY RealStart DESC";
} 

if ($Pswf == "y") {
  $sql = "SELECT DATE_FORMAT(LEFT(RealStart,10),'%d/%m/%Y') AS data, MID(RealStart,12,8) AS entrada, ADDTIME (MID(RealStart, 12, 8),LEFT(RealDuration,8)) AS saida, JobId AS codigo, Name AS titulo, LEFT(RealDuration,8) AS duracao, Channel AS canal FROM AsRun.AsRun WHERE Name LIKE '%$Ptitulo%' AND JobId NOT Like '%.png' AND JobId LIKE '%$Pcodigo%' AND (DATE(RealStart) BETWEEN '$Pdatainicial' AND '$Pdatafinal') ORDER BY RealStart DESC";
}


$result = mysqli_query($conn, $sql);

if (mysqli_num_rows($result) > 0) {
    echo "<center><table style=width:950px><tr><th>Data</th><th>Entrada</th><th>Saída</th><th>Código</th><th>Título</th><th>Duração</th><th>Canal</th></tr>";

    // output data of each row
    while($row = mysqli_fetch_assoc($result)) {
        echo "<tr><td>" . $row["data"] . "</td><td>" . $row["entrada"] . "</td><td>" . $row["saida"] . "</td><td>" . $row["codigo"] . "</td><td>" . $row["titulo"] . "</td><td>" . $row["duracao"] . "</td><td>".$row["canal"]."</td></tr>";
    }
    echo "</table></center>";

} else {
    echo "Nenhum resultado encontrado";
}

mysqli_close($conn);

echo '</br>';


?>

</body>

</html>
---------------------------------------------------------------------------



- RELATÓRIO ANCINE
---------------------------------------------------------------------------
<html>
<?php  // /usr/local/nginx/html/ancine/index.php ?>

<head>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1" />
<title>Relatório ANCINE</title>

<style>
span.tab{
    padding: 0 50px;
}

table {
  border: 1px solid black;
}

th {
  border-bottom: 1px solid #ddd;
  border-collapse: collapse;
  background-color:#f3f3f3;
  text-align: center
  padding: 3px;
  font-size: 16px;
}

td {
  border-bottom: 1px solid #ddd;
  border-collapse: collapse;
  text-align: center
  padding: 3px;
  font-size: 10px;
  height: 20px;
  text-align: center;
}

tr:hover {background-color:#f3f3f3;}

// img { vertical-align: middle; }

</style>
</head>

<body>

<font face = "Verdana">
<h1 style=font-size:45px><img src="./redenew_logo_asrun.png" alt="logo_redenew face" height="80"><span class="tab"></span><u>Relatório ANCINE</u></h1>

<form action="#">

  <?php
    $d = strtotime("-1 month");
    $ontem = date("Y-m", $d);
    if ( !isset($_GET['Panomes']) ) {
      echo ' Mês/Ano: <input type="month" name="Panomes" autofocus value='.$ontem.">";
    } else {
      echo ' Mês/Ano: <input type="month" name="Panomes" autofocus value='.($_GET['Panomes']).">";
    }
  ?>

  &nbsp;&nbsp;<input type="submit" value="Pesquisar" style="height:25px"></br>

</form>


<?php 

header("Content-Type: text/html; charset=ISO-8859-1",true); 
ini_set('display_errors', true);
error_reporting(E_ALL|E_STRICT);

// funções

function test_input($data) {
  $data = trim($data);
  $data = stripslashes($data);
  $data = htmlspecialchars($data);
  return $data;
}


// dados iniciais
$sql = "";
$d = strtotime("-1 month");
$ontem = date("Y-m", $d);
$Panomes = $ontem;

if(!empty($_GET) && $_SERVER['REQUEST_METHOD'] == 'GET'){
    $Panomes = $_GET['Panomes'];
} 

// Create connection
$username = "root";
$password = "g2p88";
$server = "10.0.0.160";
$database = "AsRun";

$conn = new mysqli($server, $username, $password, $database);

// Check connection
if (!$conn) {
    die("Connection failed: " . mysqli_connect_error());
}


$sql = "SELECT '3971330001' AS 'ancine', DATE_FORMAT(LEFT(RealStart,10), '%d/%m/%y') AS 'data', MID(RealStart, 12, 8) AS 'inicio', ADDTIME (MID(RealStart, 12, 8), LEFT(RealDuration, 8)) AS 'termino', JobId AS 'nome', '' AS 'episodio', '' as 'diretor',  '' as 'cpb', '' as 'crt', `Name` AS 'titulo', '' AS 'ano', MovieType AS 'tipo', '' AS 'codigo' FROM AsRun.AsRun WHERE JobId NOT LIKE '%.swf' AND JobId NOT LIKE '%.png' AND DATE(Realstart) LIKE '$Panomes%' ORDER BY RealStart ASC";

$result = mysqli_query($conn, $sql);

if (mysqli_num_rows($result) > 0) {
    echo "<center><table style=width:98%><tr><th>Num Ancine</th><th>Data</th><th>Início</th><th>Término</th><th>Nome</th><th>Episódio</th><th>Diretor</th><th>CPB</th><th>CRT</th><th>Título Original</th><th>Ano</th><th>Tipo</th><th>Cod</th></tr>";

    // output data of each row
    while($row = mysqli_fetch_assoc($result)) {
        echo "<tr><td>".$row["ancine"] . "</td><td>" .$row["data"] . "</td><td>" . $row["inicio"] . "</td><td>" . $row["termino"] . "</td><td>".$row["nome"]."</td><td>" . $row["episodio"] . "</td><td>" . $row["diretor"] . "</td><td>" . $row["cpb"] . "</td><td>".$row["crt"]."</td><td>".$row["titulo"]."</td><td>".$row["ano"]."</td><td>".$row["tipo"]."</td><td>".$row["codigo"]."</td></tr>";
    }
    echo "</table></center>";

} else {
    echo "Nenhum resultado encontrado";
}

mysqli_close($conn);

echo '</br>';


?>

</body>

</html>
---------------------------------------------------------------------------


- Query para alterar data de eventos (atenção na terceira linha!):
UPDATE AsRun SET BCastDay=DATE_FORMAT(BCastDay,'2019-08-25 %T.000') WHERE RealStart LIKE '2018-09-25%';
UPDATE AsRun SET Date=DATE_FORMAT(Date,'2019-08-25 %T.000') WHERE RealStart LIKE '2018-09-25%';
UPDATE AsRun SET RealStart=REPLACE(RealStart,'2018-09-25','2019-08-25') WHERE RealStart LIKE '2018-09-25%'

- Ethernet para Raspbery Zero:
https://www.instructables.com/id/Super-Cheap-Ethernet-for-the-Raspberry-Pi/